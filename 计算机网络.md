# ping 的原理
## ip协议的助手-- ICMP协议
ping是基于ICMP协议工作的，所以要明白ping的工作，首先要熟悉ICMP协议。
***

### ICMP的概念
Internet Control Message Protocol-互联网控制报文协议

网络包在复杂的网络传输环境里，常常会遇到各种问题。当遇到问题的时候，总不能死个不明不白，没头没脑的作风不是计算机网络的风格。所以需要传出消息，报告遇到了什么问题，这样才可以调整传输策略，以此来控制整个局面。
***
### ICMP的功能
ICMP的功能包括：确认IP包是否成功送达目标地址、报告发送过程中IP包被废弃的原因和改善网络设置等。

在IP通信中，如果某个IP包因为某种原因未能达到目标地址，那么这个具体的原因将由ICMP负责通知。

[![ROOk5T.png](https://z3.ax1x.com/2021/07/08/ROOk5T.png)](https://imgtu.com/i/ROOk5T)
主机A向主机B发送了数据包，由于某种原因，途中的路由器2未能发现主机B的存在，这时路由器2就会向主机A发送一个ICMP目标不可达数据包，说明发往主机B的包未能成功。

ICMP的通知消息会使用IP进行发送。

因此，从路由器2返回的ICMP包会按照往常的路由控制先经过路由器1再转发给主机A

收到该ICMP包的主机A则分解ICMP的首部和数据域以后得知具体发生问题的原因。
***
### ICMP包头格式
icmp报文是封装在ip包里面，它工作在网络层，是ip协议的助手。
![icmp包头格式](https://mmbiz.qpic.cn/mmbiz_png/J0g14CUwaZcZiaMXRx5FarzuAMKmf0Cj29gb37HdxOjFprAJ1zycOxZdHEbz4tafArtrZFAibw90Dn1BJmgaG5eg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

# ip数据报
![ip数据报](https://gitee.com/BloothOfYouth/image/raw/master//20201020153846.png)
- 一个 IP 数据报由首部和数据两部分组成。
- 首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。
- 图中的每一行都由32个比特（也就是4个字节）构成，每个小格子称为字段或者域，每个字段或某些字段的组合用来表达IP协议的相关功能。
## 各字段的作用
aaa